#!/bin/bash
#
# Claude Code Sandbox Container Wrapper Script
# ======================================
# This script runs Claude Code inside a Docker container with proper isolation
# while maintaining access to your workspace and git config.
#
# Usage: ./claude [args...]
#   ./claude                              # Start interactive session
#   ./claude --debug                      # Debug mode
#   ./claude -p /workspace                # Specify workspace path
#   ./claude --ssh-key id_ed25519         # Use specific SSH key
#   ./claude --ssh-key ~/.ssh/custom_key  # Use custom key path
#   ./claude --cpus 4                     # Allocate 4 CPUs
#   ./claude --memory 4g                  # Set memory limit to 4GB
#   ./claude --max-thinking-tokens 10000  # Set MAX_THINKING_TOKENS env var
#   ./claude --max-thinking                # Set MAX_THINKING_TOKENS to 63999
#   ./claude "fix the bug"                # Execute prompt (auto-converted to -p)
#   ./claude --debug "analyze logs"       # Combine flags and prompts
#
# Environment Variables:
#   CLAUDE_SSH_KEY    # Default SSH key to use (e.g., "id_ed25519")
#
# The container automatically:
#   - Mounts your current directory as the workspace
#   - Syncs your git configuration and forwards SSH keys
#   - Generates unique container names for multiple instances
#   - Cleans up when the session ends (--rm flag)

set -e  # Exit on any error

# ============================================================================
# Configuration
# ============================================================================

CLAUDE_DIR="${HOME}/.claude-sandbox"        # Persistent config directory
IMAGE="claude-code-sandbox:latest"          # Docker image name
NAME_PREFIX="claude-sandbox-"               # Container name prefix
SSH_KEY="${CLAUDE_SSH_KEY:-id_ed25519}"     # SSH key to load (from env or flag)
CPUS="4"                                    # Default CPU allocation
MEMORY="4g"                                 # Default memory limit
MAX_THINKING_TOKENS=""                      # Optional: MAX_THINKING_TOKENS env var

# ============================================================================
# Argument Parsing
# ============================================================================
# Parse arguments to extract --ssh-key flag and detect prompts.
# Positional arguments (non-flags) are treated as prompts and automatically
# prefixed with -p for the Claude CLI.

CLAUDE_ARGS=()
PROMPT_ARG=""
while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help)
            cat <<'HELP'
Claude Code Sandbox Container Wrapper
======================================

Usage: ./claude [OPTIONS] [PROMPT]

Options:
  -h, --help                    Show this help message and exit

  Container Resources:
  --cpus N                      Allocate N CPUs to the container (default: 4)
  --memory SIZE                 Set memory limit (e.g., 4g, 512m) (default: 4g)

  SSH Configuration:
  --ssh-key KEY                 Use specific SSH key (name or path)
                                Examples: --ssh-key id_ed25519
                                          --ssh-key ~/.ssh/custom_key
                                Environment: CLAUDE_SSH_KEY

  Claude Configuration:
  --max-thinking                Set MAX_THINKING_TOKENS to maximum (63999)
  --max-thinking-tokens N       Set MAX_THINKING_TOKENS environment variable
                                Maximum value: 63999
                                Controls the thinking token limit for Claude

  Claude CLI Flags:
  Any other flags (e.g., --debug, -p) are passed directly to Claude CLI

Examples:
  ./claude                                    # Start interactive session
  ./claude --help                             # Show this help
  ./claude --debug                            # Debug mode
  ./claude --cpus 8 --memory 8g              # Use more resources
  ./claude --max-thinking                      # Max thinking tokens (63999)
  ./claude --max-thinking-tokens 10000        # Set thinking token limit
  ./claude --ssh-key id_rsa                   # Use specific SSH key
  ./claude "fix the bug"                      # Execute prompt (auto -p flag)
  ./claude --debug "analyze logs"             # Combine flags and prompts

Environment Variables:
  CLAUDE_SSH_KEY               Default SSH key to use (default: id_ed25519)

Notes:
  - The container automatically mounts your current directory as workspace
  - Git configuration is synced from ~/.gitconfig
  - SSH agent is forwarded for git operations
  - Each run creates a uniquely named container (claude-sandbox-N)
  - Containers are automatically removed on exit (--rm flag)

For more information, see the project README or CLAUDE.md
HELP
            exit 0
            ;;
        --ssh-key)
            SSH_KEY="$2"
            shift 2
            ;;
        --ssh-key=*)
            SSH_KEY="${1#*=}"
            shift
            ;;
        --cpus)
            CPUS="$2"
            shift 2
            ;;
        --cpus=*)
            CPUS="${1#*=}"
            shift
            ;;
        --memory)
            MEMORY="$2"
            shift 2
            ;;
        --memory=*)
            MEMORY="${1#*=}"
            shift
            ;;
        --max-thinking)
            MAX_THINKING_TOKENS="63999"
            shift
            ;;
        --max-thinking-tokens)
            MAX_THINKING_TOKENS="$2"
            shift 2
            ;;
        --max-thinking-tokens=*)
            MAX_THINKING_TOKENS="${1#*=}"
            shift
            ;;
        -p|--print)
            # User explicitly passed -p, use next arg as prompt
            CLAUDE_ARGS+=("$1")
            shift
            ;;
        -*)
            # Other flags, pass through
            CLAUDE_ARGS+=("$1")
            shift
            ;;
        *)
            # Positional argument - treat as prompt if no flag prefix
            # Store it to add with -p later
            if [[ -z "$PROMPT_ARG" ]]; then
                PROMPT_ARG="$1"
            else
                # Multiple positional args - just pass through
                CLAUDE_ARGS+=("$1")
            fi
            shift
            ;;
    esac
done

# If we have a prompt argument without -p flag, add it properly
if [[ -n "$PROMPT_ARG" ]]; then
    CLAUDE_ARGS+=("-p" "$PROMPT_ARG")
fi

echo "ðŸš€ Claude Code Sandbox Container Launcher"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

mkdir -p "$CLAUDE_DIR"

# ============================================================================
# Docker Check
# ============================================================================
# Ensure Docker is running before attempting to launch containers

echo "ðŸ”§ Checking Docker..."

if ! docker info >/dev/null 2>&1; then
    echo "   âš  Docker not running, starting..."

    # Platform-specific startup
    case "$(uname -s)" in
        Darwin)
            if command -v brew &>/dev/null && brew services list | grep -q "^colima"; then
                brew services start colima 2>/dev/null || true
            elif command -v colima &>/dev/null; then
                colima start --ssh-agent 2>/dev/null || true
            fi
            ;;
        Linux)
            if command -v systemctl &>/dev/null; then
                sudo systemctl start docker 2>/dev/null || true
            fi
            ;;
    esac

    # Wait for Docker to be ready (up to 60 seconds for Colima)
    attempts=0
    max_attempts=60
    while ! docker info >/dev/null 2>&1 && [ $attempts -lt $max_attempts ]; do
        sleep 1
        ((attempts++))
    done

    if docker info >/dev/null 2>&1; then
        echo "   âœ“ Docker started successfully"
    else
        echo "   âœ— Failed to start Docker"
        echo "   â„¹ Try: brew services start colima"
        exit 1
    fi
else
    echo "   âœ“ Docker is running"
fi

# ============================================================================
# Container Launch
# ============================================================================
# Generate a unique container name and launch with all necessary mounts

# Find the next available number for the container name
# by checking existing containers with the same prefix
NEXT_NUM=$(docker ps -a --format '{{.Names}}' 2>/dev/null | \
    grep -E "^${NAME_PREFIX}[0-9]+$" | \
    sed "s/^${NAME_PREFIX}//" | \
    sort -n | tail -1 | \
    awk '{print $1 + 1}')
NEXT_NUM=${NEXT_NUM:-0}

# Generate unique container name with incremental number
NAME="${NAME_PREFIX}${NEXT_NUM}"

echo "ðŸ³ Launching container: $NAME"
echo "ðŸ“ Workspace: $(pwd)"

# ============================================================================
# Setup: Git Configuration
# ============================================================================

echo "ðŸ“ Syncing git configuration..."

if [ -f "$HOME/.gitconfig" ]; then
    # Copy gitconfig to sandbox directory if it doesn't exist or is outdated
    if [ ! -f "$CLAUDE_DIR/.gitconfig" ] || [ "$HOME/.gitconfig" -nt "$CLAUDE_DIR/.gitconfig" ]; then
        cp -f "$HOME/.gitconfig" "$CLAUDE_DIR/.gitconfig"
        echo "   âœ“ Git config copied to sandbox"
    else
        echo "   â„¹ Git config already up to date"
    fi
else
    echo "   âš  No .gitconfig found in $HOME"
fi

# ============================================================================
# Setup: SSH Configuration
# ============================================================================

echo "ðŸ”‘ Loading SSH keys..."

# If SSH_KEY is specified, load only that key; otherwise load all keys
if [ -n "$SSH_KEY" ]; then
    # Resolve the SSH key path
    if [[ "$SSH_KEY" == /* ]] || [[ "$SSH_KEY" == ~* ]]; then
        # Absolute path or path with ~
        SSH_KEY_PATH="${SSH_KEY/#\~/$HOME}"
    else
        # Assume it's a key name in ~/.ssh/
        SSH_KEY_PATH="$HOME/.ssh/$SSH_KEY"
    fi

    # Verify the key exists
    if [ ! -f "$SSH_KEY_PATH" ]; then
        echo "   âœ— SSH key not found: $SSH_KEY_PATH"
        echo "   Available keys in ~/.ssh/:"
        ls -1 "$HOME/.ssh/" | grep -E '^(id_|.*\.pub$)' | grep -v '\.pub$' || echo "   (none found)"
        exit 1
    fi

    # Clear existing keys and add only the specified one
    ssh-add -D 2>/dev/null || true
    ssh-add "$SSH_KEY_PATH"
    echo "   âœ“ Loaded SSH key: $(basename "$SSH_KEY_PATH")"
else
    # Load all default keys
    ssh-add
    echo "   âœ“ Loaded all available SSH keys"
fi

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Build the docker run command with appropriate flags
# -it: Interactive terminal
# --rm: Remove container after exit
# -e SSH_AUTH_SOCK: Forward SSH agent (platform-specific socket path)
# --group-add: Add socket's group for SSH access (macOS)
# -w: Set working directory
# -v: Volume mounts for config, workspace, and IDE settings

# Trap signals to ensure clean shutdown
cleanup() {
    echo ""
    echo "ðŸ›‘ Shutting down container..."
    docker stop "$NAME" 2>/dev/null || true
}
trap cleanup EXIT INT TERM

# Build SSH forwarding arguments based on platform
# macOS with Colima: Use the Colima VM's forwarded socket at /run/host-services/ssh-auth.sock
# Linux: Use $SSH_AUTH_SOCK directly
SSH_FORWARD_ARGS=()
CONTAINER_SSH_SOCK=""

case "$(uname -s)" in
    Darwin)
        # Colima provides SSH agent at a fixed path inside the VM
        COLIMA_SSH_SOCK="/run/host-services/ssh-auth.sock"
        if colima ssh -- test -S "$COLIMA_SSH_SOCK" 2>/dev/null; then
            CONTAINER_SSH_SOCK="/tmp/ssh-agent.sock"
            SSH_FORWARD_ARGS=(
                -v "$COLIMA_SSH_SOCK:$CONTAINER_SSH_SOCK"
                -e "SSH_AUTH_SOCK=$CONTAINER_SSH_SOCK"
            )
        else
            echo "   âš  SSH agent not available in Colima VM"
            echo "   â„¹ Restart Colima with: colima stop && colima start --ssh-agent"
        fi
        ;;
    Linux)
        # Linux uses the host SSH socket directly
        if [ -n "$SSH_AUTH_SOCK" ] && [ -S "$SSH_AUTH_SOCK" ]; then
            SSH_FORWARD_ARGS=(
                -v "$SSH_AUTH_SOCK:$SSH_AUTH_SOCK"
                -e "SSH_AUTH_SOCK=$SSH_AUTH_SOCK"
            )
        fi
        ;;
esac

# Build environment variable arguments
ENV_ARGS=()
if [ -n "$MAX_THINKING_TOKENS" ]; then
    ENV_ARGS+=(-e "MAX_THINKING_TOKENS=$MAX_THINKING_TOKENS")
fi

docker run -it --rm \
    -w "$(pwd)" \
    --name "$NAME" \
    --cpus "$CPUS" --memory "$MEMORY" \
    "${SSH_FORWARD_ARGS[@]}" \
    "${ENV_ARGS[@]}" \
    -v "$CLAUDE_DIR:/home/claude" \
    -v "$HOME/.claude/ide:/home/claude/.claude/ide:ro" \
    -v "$(pwd):$(pwd)" \
    "$IMAGE" "${CLAUDE_ARGS[@]}"

# Container exited, cleanup trap will handle the rest
